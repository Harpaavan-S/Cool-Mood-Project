<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mood Tracker</title>
    <script src="https://cdn.jsdelivr.net/npm/@teachablemachine/image@0.8.4"></script>
    <link href="https://fonts.googleapis.com/css2?family=Roboto+Slab&family=Sacramento&family=Chewy&family=Gloria+Hallelujah&family=Rock+Salt&family=Righteous&family=Sacramento&family=Roboto+Slab&display=swap" rel="stylesheet">
    <style>
        /* Style for buttons */
        button {
            font-size: 18px;
            padding: 10px;
            cursor: pointer;
            margin: 5px;
        }

        .selected {
            background-color: #f44336;
            color: white;
        }

        .greyed {
            background-color: #dddddd;
        }

        /* Styling for overall page */
        body {
            font-family: Arial, sans-serif;
            background: linear-gradient(to top right, #ff6666, #ff9933);
            text-align: center;
            padding: 20px;
        }

        /* Styling for the title */
        #title {
            font-size: 36px;
            font-family: 'Sacramento', cursive;
            margin-bottom: 20px;
        }

        /* Emoji container */
        #emoji {
            font-size: 100px;
        }

        /* Styling for iframe */
        iframe {
            border: none;
            width: 100%;
            max-width: 500px;
            height: 300px;
            margin-top: 20px;
        }

        /* Webcam style */
        #webcam {
            width: 100%;
            max-width: 500px;
            border: 2px solid #000;
            margin-top: 20px;
        }

        #background-shapes {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            background: linear-gradient(to top right, #ff6666, #ff9933);
        }
    </style>
</head>
<body>

<div id="background-shapes"></div>

<video id="webcam" width="640" height="480" autoplay></video>

<div id="title">Mood Tracker</div>
<div id="emoji">ðŸ˜Š</div>

<iframe id="spotify-player" class="spotify-player" src="https://open.spotify.com/embed/track/32OlwWuMpZ6b0aN2RZOeMS?utm_source=generator" width="600" height="300" frameborder="0" allow="autoplay; clipboard-write; encrypted-media; fullscreen; picture-in-picture" loading="lazy"></iframe>

<!-- Buttons for mood -->
<button id="angryBtn">Angry</button>
<button id="happyBtn">Happy</button>
<button id="surprisedBtn">Surprised</button>
<button id="calmBtn">Calm</button>
<button id="sadBtn">Sad</button>
<button id="scaredBtn">Scared</button>

<script>
    let model, webcam, labelContainer, maxPredictions;
    let lastPredictedLabel = '';
    let predictionTime = 0;

    // Initialize the Teachable Machine Model
    async function init() {
        const modelURL = 'https://teachablemachine.withgoogle.com/models/jf-a5_tbm/model.json';
        const metadataURL = 'https://teachablemachine.withgoogle.com/models/jf-a5_tbm/metadata.json';
        
        // Load the model
        try {
            model = await tmImage.load(modelURL, metadataURL);
            maxPredictions = model.getTotalClasses();
            console.log("Teachable Machine Model Loaded Successfully!");
        } catch (error) {
            console.error("Error loading Teachable Machine model: ", error);
            alert("Error loading Teachable Machine model.");
            return;
        }
        
        // Set up the webcam
        try {
            webcam = await tmImage.Webcam.setup();
            await webcam.play();
            document.getElementById('webcam').srcObject = webcam.webcam;
            console.log("Webcam initialized successfully!");
        } catch (error) {
            console.error("Error setting up webcam: ", error);
            alert("Error setting up webcam.");
            return;
        }

        // Start the continuous prediction loop
        window.requestAnimationFrame(predictWebcam);
    }

    async function predictWebcam() {
        webcam.update();
        
        // Get predictions from the Teachable Machine model
        const predictions = await model.predict(webcam.canvas);
        
        // Find the most confident prediction with a confidence >= 70%
        const topPrediction = predictions.reduce((best, current) => 
            current.probability > best.probability ? current : best
        );
        
        // If the confidence is above 70%, and the label stays for 3 seconds, change mood
        if (topPrediction.probability >= 0.7) {
            if (topPrediction.className !== lastPredictedLabel) {
                predictionTime = Date.now();
            }
            lastPredictedLabel = topPrediction.className;
            
            if (Date.now() - predictionTime >= 3000) {
                updatePageForMood(lastPredictedLabel);
            }
        } else {
            // Reset the timer if the confidence drops below 70%
            predictionTime = 0;
            lastPredictedLabel = '';
        }

        // Keep predicting every frame
        window.requestAnimationFrame(predictWebcam);
    }

    function updatePageForMood(mood) {
        const moodSettings = {
            angry: { 
                color: '#ff6b6b', 
                emoji: 'ðŸ˜¡', 
                trackUrl: 'https://open.spotify.com/embed/track/1P17dC1amhFzptugyAO7Il?utm_source=generator',
                font: 'Roboto Slab',
                title: 'Let it out! ðŸ˜¡',
                background: 'radial-gradient(circle, #ff6b6b, #ff4d4d)'
            },
            happy: { 
                color: '#f9e300', 
                emoji: 'ðŸ˜Š', 
                trackUrl: 'https://open.spotify.com/embed/track/32OlwWuMpZ6b0aN2RZOeMS?utm_source=generator',
                font: 'Chewy', 
                title: 'Enjoy the moment! ðŸ˜Š',
                background: 'radial-gradient(circle, #f9e300, #f57c00)'
            },
            surprised: { 
                color: '#ff9800', 
                emoji: 'ðŸ˜²', 
                trackUrl: 'https://open.spotify.com/embed/track/5UMgKsx50UqgN7VMNmeDuW?utm_source=generator',
                font: 'Gloria Hallelujah',
                title: 'Wow, that\'s unexpected! ðŸ˜²',
                background: 'radial-gradient(circle, #ff9800, #ff5722)'
            },
            calm: { 
                color: '#81c784', 
                emoji: 'ðŸ˜Œ', 
                trackUrl: 'https://open.spotify.com/embed/track/6pWgRkpqVfxnj3WuIcJ7WP?utm_source=generator',
                font: 'Sacramento', 
                title: 'Breathe and relax. ðŸ˜Œ',
                background: 'radial-gradient(circle, #81c784, #4caf50)'
            },
            sad: { 
                color: '#7986cb', 
                emoji: 'ðŸ˜”', 
                trackUrl: 'https://open.spotify.com/embed/track/3bNv3VuUOKgrf5hu3YcuRo?utm_source=generator',
                font: 'Righteous', 
                title: 'It\'s okay to feel down. ðŸ˜”',
                background: 'radial-gradient(circle, #7986cb, #5c6bc0)'
            },
            scared: { 
                color: '#9c27b0', 
                emoji: 'ðŸ˜¨', 
                trackUrl: 'https://open.spotify.com/embed/track/6i0V12jOa3mr6uu4WYhUBr?utm_source=generator',
                font: 'Rock Salt', 
                title: 'Stay strong! ðŸ˜¨',
                background: 'radial-gradient(circle, #9c27b0, #6a1b9a)'
            }
        };

        const moodSetting = moodSettings[mood];
        
        if (!moodSetting) return;

        document.body.style.backgroundColor = moodSetting.color;
        document.getElementById('background-shapes').style.background = moodSetting.background;
        document.getElementById('emoji').textContent = moodSetting.emoji;
        document.getElementById('title').textContent = moodSetting.title;
        document.getElementById('title').style.fontFamily = moodSetting.font;

        // Update Spotify track
        document.getElementById('spotify-player').src = moodSetting.trackUrl;

        // Select the corresponding button
        const selectedButton = document.getElementById(`${mood}Btn`);
        selectedButton.classList.add('selected');
        
        // Deselect other buttons
        document.querySelectorAll('button').forEach(button => {
            if (button !== selectedButton) {
                button.classList.remove('selected');
                button.classList.add('greyed');
            }
        });
    }

    // Start the model and webcam
    init();
</script>

</body>
</html>
